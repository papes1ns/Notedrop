{% extends 'base.html' %}
{% load pagination_tags %}

{% block title %}Notedrop Feed{% endblock %}

{% block content %}
<!-- <div class='sidebar'>

<h2>Filter feed by course <a href='{% url 'feed' %}'>Clear Filter</a></h2>
<ul>
  {% for course in courses %}
    <li><a href='{% url 'feed' %}{% if filter %}?courseid={{ course.pk }}&filter={{ filter }}{% else %}?courseid={{ course.pk }}{% endif %}' {% if filter_course == course.pk %}style='color: rgb(166, 2, 105);'{% endif %}>{{ course }}</a></li>
  {% endfor %}
</ul>

<a href={% url 'state_selection' %}>Add another course</a>

<h2>Drop a Note</h2>
<form class='note-form' action='{% url 'feed' %}?courseid={{ filter_course }}' method='post'>
  {% csrf_token %}
  <table>
    {{ form.as_table }}
  </table>
  <button class='submit-note' type='submit'>Drop Note</button>
</form>
</div> -->
<!-- end of sidebar -->

<div class='notefeed'>
<h2>Note Feed</h2>
<h3>
  <a href='{% url 'feed' %}{% if filter_course %}?courseid={{ filter_course }}&filter=latest{% else %}?filter=latest{% endif %}' {% if filter == 'latest' %}style='color: rgb(166, 2, 105);'{% endif %}>Latest</a>
  <a href='{% url 'feed' %}{% if filter_course %}?courseid={{ filter_course }}&filter=rating{% else %}?filter=rating{% endif %}' {% if filter == 'rating' %}style='color: rgb(166, 2, 105);'{% endif %}>Rating</a>
</h3>
{% autopaginate posts 5 %}
{% for post in posts %}
<div class='post'>

  <div class='post-info'>
    <span class='post-course'>{{ post.obj.course }}</span>
    <span class='post-author'><a href='{% url 'users' username=post.obj.author %}'>{{ post.obj.author }}</a></span>
    <p class='post-content'>{{ post.obj }}</p>
    <span class='post-created'>Created {{ post.obj.created }}</span>
    <a class='post-permalink' href='{% url 'posts' post_pk=post.obj.pk %}'>&#8734;</a>
  </div>

  <div class='post-options post-{{ post.obj.pk }}'>
    <button class='post-options-btn noted-btn' object='{{ post.obj.pk }}' {% if post.noted %}style='color: rgb(255, 145, 0);'{% endif %}>&#9733;</button>
    <button class='post-options-btn up-btn' object='{{ post.obj.pk }}' {% if post.upvote == True %}style='color: rgb(255, 145, 0);'{% endif %}>&#9650;</button>
    <span class='post-rating'>{{ post.obj.rating }}</span>
    <button class='post-options-btn down-btn' object='{{ post.obj.pk }}' {% if post.upvote == False %}style='color: rgb(255, 145, 0);'{% endif %}>&#9660;</button>
  </div>

</div>
{% endfor %}
{% paginate %}
</div>
<!-- end of notefeed  -->
{% endblock %}

{% block extra_head %}
<script>
$(document).ready(function(){

  $('.noted-btn').click(function(){
    var btn = $(this);
    $.post('{% url 'post_options' %}', {'noted_pk': $(this).attr('object')})
      .done(function(data){
        data = JSON.parse(data);
        if(data == true){
          btn.css('color', 'rgb(255, 145, 0)');
        }
        else {
          btn.css('color', 'rgb(193, 193, 193)');
        }
      });
  });

  $('.up-btn').click(function(){
    $.post('{% url 'post_options' %}', {'up_pk': $(this).attr('object')})
      .done(function(data){
        data = JSON.parse(data);
        update_rating_btns(data);
      });
  });

  $('.down-btn').click(function(){
    $.post('{% url 'post_options' %}', {'down_pk': $(this).attr('object')})
      .done(function(data){
        data = JSON.parse(data);
        update_rating_btns(data);
      });
  });
});

function update_rating_btns(data){
  $('.post-'+data['post_pk'].toString()+' > .post-rating').text(data['rating']);
  if(data['upvote'] == true){
    $('.post-'+data['post_pk'].toString()+' > .up-btn').css('color', 'rgb(255, 145, 0)');
    $('.post-'+data['post_pk'].toString()+' > .down-btn').css('color', 'rgb(193, 193, 193)');
  }
  else if(data['upvote'] == false){
    $('.post-'+data['post_pk'].toString()+' > .down-btn').css('color', 'rgb(255, 145, 0)');
    $('.post-'+data['post_pk'].toString()+' > .up-btn').css('color', 'rgb(193, 193, 193)');
  }
  else{
    $('.post-'+data['post_pk'].toString()+' > .down-btn').css('color', 'rgb(193, 193, 193)');
    $('.post-'+data['post_pk'].toString()+' > .up-btn').css('color', 'rgb(193, 193, 193)');
  }
}

</script>

<style>
.post {
  margin-top: 20px;
}
.post-options {
  /*float: right;*/
  display: inline-block;
  vertical-align: top;
  margin-left: 10px;
  padding-bottom: 10px;
}
.post-options-btn {
  display: block;
  padding: 0;
  border: none;
  background: none;
  font-size: 22px;
}
.post-rating {
  font-size: 18px;
  padding-left: 5px;
}
.post-info {
  /*margin-top: 15px;
  padding-bottom: 15px;*/
  /*float: left;*/
  display: inline-block;
  vertical-align: top;
  width: 600px;
  border-bottom: 1px solid rgb(0, 158, 200);
}
.post-course {
  font-size: 12px;
  color: rgb(166, 2, 105);
}
.post-author {
  float: right;
}
.post-content {
  font-size: 20px;
  padding-top: 15px;
  padding-left: 15px;
  padding-bottom: 15px;
}
.post-created {
  font-size: 10px;
  font-style: italic;
}
.post-permalink {
  text-decoration: none;
  font-size: 18px;
  float: right;
}
</style>
{% endblock %}
